var __extends=this.__extends||function(n,t){function r(){this.constructor=n}for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);r.prototype=t.prototype;n.prototype=new r},CZ;(function(n){(function(t){var i=function(t){function i(i,r){var u=this;t.call(this,i,r);this.titleTextblock=i.find(r.titleTextblock);this.titleInput=i.find(r.titleInput);this.datePicker=new n.UI.DatePicker(i.find(r.datePicker));this.createArtifactButton=i.find(r.createArtifactButton);this.contentItemsListbox=new n.UI.ContentItemListbox(i.find(r.contentItemsListbox),r.contentItemsTemplate,r.context.contentItems);this.errorMessage=i.find(r.errorMessage);this.saveButton=i.find(r.saveButton);this.deleteButton=i.find(r.deleteButton);this.titleInput.focus(function(){u.titleInput.hideError()});this.contentItemsTemplate=r.contentItemsTemplate;this.exhibit=r.context;this.exhibitCopy=$.extend({},r.context,{children:null});this.exhibitCopy=$.extend(!0,{},this.exhibitCopy);delete this.exhibitCopy.children;this.mode=n.Authoring.mode;this.isCancel=!0;this.isModified=!1;this.initUI()}return __extends(i,t),i.prototype.initUI=function(){var t=this;this.saveButton.prop("disabled",!1);this.titleInput.change(function(){t.isModified=!0});this.datePicker.datePicker.change(function(){t.isModified=!0});this.mode==="createExhibit"?(this.titleTextblock.text("Create Exhibit"),this.saveButton.text("Create Exhibit"),this.titleInput.val(this.exhibit.title||""),this.datePicker.setDate(Number(this.exhibit.infodotDescription.date)||"",!0),this.closeButton.show(),this.createArtifactButton.show(),this.saveButton.show(),this.deleteButton.hide(),this.createArtifactButton.off(),this.createArtifactButton.click(function(){return t.onCreateArtifact()}),this.saveButton.off(),this.saveButton.click(function(){return t.onSave()}),this.contentItemsListbox.itemDblClick(function(n,i){return t.onContentItemDblClick(n,i)}),this.contentItemsListbox.itemRemove(function(n,i){return t.onContentItemRemoved(n,i)}),this.contentItemsListbox.itemMove(function(n,i,r){return t.onContentItemMove(n,i,r)})):this.mode==="editExhibit"?(this.titleTextblock.text("Edit Exhibit"),this.saveButton.text("Update Exhibit"),n.Service.getExhibitLastUpdate(this.exhibit.id.substring(1)).done(function(n){t.saveButton.data("lastUpdate",n)}),this.titleInput.val(this.exhibit.title||""),this.datePicker.setDate(Number(this.exhibit.infodotDescription.date)||"",!0),this.closeButton.show(),this.createArtifactButton.show(),this.saveButton.show(),this.deleteButton.show(),this.createArtifactButton.off(),this.createArtifactButton.click(function(){return t.onCreateArtifact()}),this.saveButton.off(),this.saveButton.click(function(){return t.onSave()}),this.deleteButton.off(),this.deleteButton.click(function(){return t.onDelete()}),this.contentItemsListbox.itemDblClick(function(n,i){return t.onContentItemDblClick(n,i)}),this.contentItemsListbox.itemRemove(function(n,i){return t.onContentItemRemoved(n,i)}),this.contentItemsListbox.itemMove(function(n,i,r){return t.onContentItemMove(n,i,r)})):console.log("Unexpected authoring mode in exhibit form.")},i.prototype.onCreateArtifact=function(){var t,i,r;this.isModified=!0;this.exhibit.contentItems.length<n.Settings.infodotMaxContentItemsCount?(this.exhibit.title=this.titleInput.val()||"",this.exhibit.x=this.datePicker.getDate()-this.exhibit.width/2,this.exhibit.infodotDescription={date:this.datePicker.getDate()},t={title:"",uri:"",mediaSource:"",mediaType:"",attribution:"",description:"",order:this.exhibit.contentItems.length},this.exhibit.contentItems.push(t),this.hide(!0),n.Authoring.contentItemMode="createContentItem",n.Authoring.showEditContentItemForm(t,this.exhibit,this,!0)):(i=this,r=this.errorMessage.text(),this.errorMessage.text("Sorry, only 10 artifacts are allowed in one exhibit").show().delay(7e3).fadeOut(function(){return i.errorMessage.text(r)}))},i.prototype.onSave=function(){var u=this,i=this.datePicker.getDate()-this.exhibit.width/2,r=this.exhibit.y,t,f,e;if(i+this.exhibit.width>=this.exhibit.parent.x+this.exhibit.parent.width&&(i=this.exhibit.parent.x+this.exhibit.parent.width-this.exhibit.width),i<=this.exhibit.parent.x&&(i=this.exhibit.parent.x),r+this.exhibit.height>=this.exhibit.parent.y+this.exhibit.parent.height&&(r=this.exhibit.parent.y+this.exhibit.parent.height-this.exhibit.height),r<=this.exhibit.parent.y&&(r=this.exhibit.parent.y),t={title:this.titleInput.val()||"",x:i,y:r,height:this.exhibit.height,width:this.exhibit.width,infodotDescription:{date:n.Dates.getDecimalYearFromCoordinate(this.datePicker.getDate())},contentItems:this.exhibit.contentItems||[],type:"infodot"},n.Authoring.isNotEmpty(this.titleInput.val())||this.titleInput.showError("Title can't be empty"),n.Authoring.checkExhibitIntersections(this.exhibit.parent,t,!0)&&this.errorMessage.text("Exhibit intersects other elemenets"),n.Authoring.validateExhibitData(this.datePicker.getDate(),this.titleInput.val(),this.exhibit.contentItems)&&n.Authoring.checkExhibitIntersections(this.exhibit.parent,t,!0)&&this.exhibit.contentItems.length>=1&&this.exhibit.contentItems.length<=n.Settings.infodotMaxContentItemsCount)if(this.mode==="editExhibit")n.Service.getExhibitLastUpdate(this.exhibit.id.substring(1)).done(function(n){if(n==u.saveButton.data("lastUpdate"))u.onSave_PerformSave(t);else if(confirm(n.split("|")[1]+" has made changes to this exhibit since you began editing it.\n\nDo you want to replace their changes with yours? This will cause all of their changes to be lost."))u.onSave_PerformSave(t);else alert("Your changes were not saved.\n\nYou can click on your artifacts to copy off any changes you've made before closing the Edit Exhibit pane. After closing the Edit Exhibits pane, you can then refresh your browser to see the latest changes.")});else this.onSave_PerformSave(t);else this.exhibit.contentItems.length===0?(f=this,e=this.errorMessage.text(),this.errorMessage.text("Cannot create exhibit without artifacts.").show().delay(7e3).fadeOut(function(){return f.errorMessage.text(e)})):this.errorMessage.text("One or more fields filled wrong").show().delay(7e3).fadeOut()},i.prototype.onSave_PerformSave=function(t){var i=this;this.saveButton.prop("disabled",!0);n.Authoring.updateExhibit(this.exhibitCopy,t).then(function(){i.isCancel=!1;i.isModified=!1;i.close();i.exhibit.id=arguments[0].id;i.exhibit.onmouseclick()},function(t){var r=JSON.parse(t.responseText).errorMessage,f,u;r!==""?(i.errorMessage.text(r),f=i,u=n.Authoring.erroneousContentItemsList(t.responseText),u.forEach(function(n){var t=f.contentItemsListbox.items[n];t.container.find(".cz-listitem").css("border-color","red")}),r="(1/"+u.length+") "+JSON.parse(t.responseText).errorMessage,i.errorMessage.text(r)):i.errorMessage.text("Sorry, internal server error :(");i.errorMessage.show().delay(7e3).fadeOut()}).always(function(){i.saveButton.prop("disabled",!1)})},i.prototype.onDelete=function(){confirm("Are you sure want to delete the exhibit and all of its content items? Delete can't be undone!")&&(n.Authoring.removeExhibit(this.exhibit),this.isCancel=!1,this.isModified=!1,this.close())},i.prototype.onContentItemDblClick=function(t){var i,t;i=typeof t.data.order!="undefined"&&t.data.order!==null&&t.data.order>=0&&t.data.order<n.Settings.infodotMaxContentItemsCount?t.data.order:typeof t.data.guid!="undefined"&&t.data.guid!==null?this.exhibit.contentItems.map(function(n){return n.guid}).indexOf(t.data.guid):-1;t=this.contentItemsListbox.items[i];t.container.find(".cz-listitem").css("border-color","#c7c7c7");i>=0&&(this.clickedListItem=t,this.exhibit.title=this.titleInput.val()||"",this.exhibit.x=this.datePicker.getDate()-this.exhibit.width/2,this.exhibit.infodotDescription={date:this.datePicker.getDate()},this.hide(!0),n.Authoring.contentItemMode="editContentItem",n.Authoring.showEditContentItemForm(this.exhibit.contentItems[i],this.exhibit,this,!0))},i.prototype.onContentItemRemoved=function(t){var r,i;if(this.isModified=!0,r=typeof t.data.order!="undefined"&&t.data.order!==null&&t.data.order>=0&&t.data.order<n.Settings.infodotMaxContentItemsCount?t.data.order:typeof t.data.guid!="undefined"&&t.data.guid!==null?this.exhibit.contentItems.map(function(n){return n.guid}).indexOf(t.data.guid):-1,r>=0){for(this.exhibit.contentItems.splice(r,1),i=0;i<this.exhibit.contentItems.length;i++)this.exhibit.contentItems[i].order=i;this.exhibit=n.Authoring.renewExhibit(this.exhibit);n.Common.vc.virtualCanvas("requestInvalidate")}},i.prototype.onContentItemMove=function(t,i,r){var f,u;for(this.isModified=!0,f=this.exhibit.contentItems.splice(i,1)[0],this.exhibit.contentItems.splice(r,0,f),u=0;u<this.exhibit.contentItems.length;u++)this.exhibit.contentItems[u].order=u;this.exhibit=n.Authoring.renewExhibit(this.exhibit);n.Common.vc.virtualCanvas("requestInvalidate")},i.prototype.show=function(i){typeof i=="undefined"&&(i=!1);n.Authoring.isActive=!0;this.activationSource.addClass("active");this.errorMessage.hide();t.prototype.show.call(this,i?undefined:{effect:"slide",direction:"left",duration:500})},i.prototype.hide=function(n){typeof n=="undefined"&&(n=!1);t.prototype.close.call(this,n?undefined:{effect:"slide",direction:"left",duration:500});this.activationSource.removeClass("active")},i.prototype.close=function(i){var r=this;if(typeof i=="undefined"&&(i=!1),this.isModified)if(window.confirm("There is unsaved data. Do you want to close without saving?"))this.isModified=!1;else return;t.prototype.close.call(this,i?undefined:{effect:"slide",direction:"left",duration:500,complete:function(){r.datePicker.remove();r.contentItemsListbox.clear();r.titleInput.hideError()}});this.isCancel&&(this.mode==="createExhibit"?(n.VCContent.removeChild(this.exhibit.parent,this.exhibit.id),n.Common.vc.virtualCanvas("requestInvalidate")):this.mode==="editExhibit"&&(delete this.exhibit.contentItems,$.extend(this.exhibit,this.exhibitCopy),this.exhibit=n.Authoring.renewExhibit(this.exhibit),n.Common.vc.virtualCanvas("requestInvalidate")));this.activationSource.removeClass("active");n.Authoring.isActive=!1;n.Common.vc.virtualCanvas("showNonRootVirtualSpace")},i}(t.FormUpdateEntity);t.FormEditExhibit=i})(n.UI||(n.UI={}));var t=n.UI})(CZ||(CZ={}));
/*
//# sourceMappingURL=auth-edit-exhibit-form.min.js.map
*/