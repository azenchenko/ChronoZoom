var CZ;(function(n){(function(t){function d(n,t){switch(t.type){case"timeline":case"infodot":return n.x+n.width>t.x&&n.x<t.x+t.width&&n.y+n.height>t.y&&n.y<t.y+t.height;default:return!1}}function c(t,i){switch(i.type){case"infodot":return t.x===-13699999999&&(t.x=-137e8,t.width+=1),t.x<=i.infodotDescription.date&&t.x+t.width>=i.infodotDescription.date&&t.y+t.height>=i.y+i.height;case"timeline":case"rectangle":case"circle":return t.x<=i.x+n.Settings.allowedMathImprecision&&t.x+t.width>=i.x+i.width-n.Settings.allowedMathImprecision&&t.y+t.height>=i.y+i.height-n.Settings.allowedMathImprecision;default:return!0}}function v(n,i,r){var u=0,f=0,e=!1;if(!n||n.guid===null)return!0;if(!c(n,i)&&n.id!=="__root__")return!1;for(u=0,f=n.children.length;u<f;++u)if(e=r?n.children[u]===t.selectedTimeline:n.children[u]===i,!e&&d(i,n.children[u]))return!1;if(r&&t.selectedTimeline.children&&t.selectedTimeline.children.length>0)for(u=0,f=t.selectedTimeline.children.length;u<f;++u)if(!c(i,t.selectedTimeline.children[u]))return!1;return!0}function y(n,t){return c(n,t)?!0:!1}function g(){if(u.x=Math.min(o.x,f.x),u.y=Math.min(o.y,f.y),u.width=Math.abs(o.x-f.x),u.height=Math.abs(o.y-f.y),v(i,u,!1)){var t=$.extend({},i.settings);t.strokeStyle="yellow";$.extend(l,u);n.VCContent.removeChild(i,"newTimelineRectangle");n.VCContent.addRectangle(i,i.layerid,"newTimelineRectangle",u.x,u.y,u.width,u.height,t)}else $.extend(u,l)}function p(){r.r=i.width>i.height?i.height/27.7:i.width/10;r.x=f.x-r.r;r.y=f.y-r.r;r.width=r.height=2*r.r;y(i,r,!1)?($.extend(a,r),n.VCContent.removeChild(i,"newExhibitCircle"),n.VCContent.addCircle(i,"layerInfodots","newExhibitCircle",r.x+r.r,r.y+r.r,r.r,{strokeStyle:"yellow"},!1)):$.extend(r,a)}function s(t){var e=t.y+t.height/2,o=t.x+t.width/2,u=t.id,s=t.contentItems,i=t.infodotDescription,r,f;return i.opacity=1,i.title=t.title,i.guid=t.guid,r=t.parent,f=t.outerRad,n.VCContent.removeChild(r,u),n.VCContent.addInfodot(r,"layerInfodots",u,o,e,f,s,i)}function w(){return n.VCContent.addTimeline(i,i.layerid,undefined,{timeStart:u.x,timeEnd:u.x+u.width,header:"Timeline Title",top:u.y,height:u.height,fillStyle:i.settings.fillStyle,regime:i.regime,gradientFillStyle:i.settings.gradientFillStyle,lineWidth:i.settings.lineWidth,strokeStyle:i.settings.gradientFillStyle})}function nt(){return n.VCContent.removeChild(i,"newExhibitCircle"),n.VCContent.addInfodot(i,"layerInfodots",undefined,r.x+r.r,r.y+r.r,r.r,[],{title:"Exhibit Title",date:r.x+r.r,guid:undefined})}function tt(t){var u=document.createElement("canvas"),f=u.getContext("2d"),i,r;t.left=t.x;t.right=t.x+t.width;i=n.Layout.GenerateTitleObject(t.height,t,f);n.VCContent.removeChild(t,t.id+"__header__");r=t.y+i.marginTop+i.height/2;t.titleObject=n.VCContent.addText(t,t.layerid,t.id+"__header__",t.x+i.marginLeft,t.y+i.marginTop,r,i.height,t.title,{fontName:n.Settings.timelineHeaderFontName,fillStyle:n.Settings.timelineHeaderFontColor,textBaseline:"middle",opacity:1},i.width);n.Authoring.isEnabled&&typeof t.editButton!="undefined"&&(t.editButton.x=t.x+t.width-1.15*t.titleObject.height,t.editButton.y=t.titleObject.y,t.editButton.width=t.titleObject.height,t.editButton.height=t.titleObject.height);typeof t.favoriteBtn!="undefined"&&(t.favoriteBtn.x=t.x+t.width-1.8*t.titleObject.height,t.favoriteBtn.y=t.titleObject.y+.15*t.titleObject.height,t.favoriteBtn.width=.7*t.titleObject.height,t.favoriteBtn.height=.7*t.titleObject.height)}function it(r,u){e=r.data("ui-virtualCanvas");e.element.on("mousedown",function(t){if(n.Authoring.isActive){var s=e.getViewport(),r=n.Common.getXBrowserMouseOrigin(e.element,t),u=s.pointScreenToVirtual(r.x,r.y);n.Authoring.isDragging=!0;o=u;h={};f=u;i=e.hovered||{}}});e.element.on("mouseup",function(t){if(n.Authoring.isActive){var r=e.getViewport(),i=n.Common.getXBrowserMouseOrigin(e.element,t),u=r.pointScreenToVirtual(i.x,i.y);n.Authoring.isDragging=!1;h=f;f=u;n.Common.controller.stopAnimation();n.Authoring.modeMouseHandlers[n.Authoring.mode].mouseup()}});e.element.on("mousemove",function(t){if(n.Authoring.isActive){var r=e.getViewport(),i=n.Common.getXBrowserMouseOrigin(e.element,t),u=r.pointScreenToVirtual(i.x,i.y);h=f;f=u;n.Authoring.modeMouseHandlers[n.Authoring.mode].mousemove()}});t.showCreateTimelineForm=u&&u.showCreateTimelineForm||function(){};t.showCreateRootTimelineForm=u&&u.showCreateRootTimelineForm||function(){};t.showEditTimelineForm=u&&u.showEditTimelineForm||function(){};t.showCreateExhibitForm=u&&u.showCreateExhibitForm||function(){};t.showEditExhibitForm=u&&u.showEditExhibitForm||function(){};t.showEditContentItemForm=u&&u.showEditContentItemForm||function(){};t.showEditTourForm=u&&u.showEditTourForm||function(){};t.showEditMapViewForm=u&&u.showEditMapViewForm||function(){};t.showMessageWindow=u&&u.showMessageWindow||function(){};t.hideMessageWindow=u&&u.hideMessageWindow||function(){};t.showSelectMapTypeForm=u&&u.showSelectMapTypeForm||function(){}}function rt(t,i){var r=jQuery.Deferred(),u={x:Number(i.start),y:t.y,width:i.end===9999?Number(n.Dates.getCoordinateFromDecimalYear(i.end)-i.start):Number(i.end-i.start),height:t.height,type:"rectangle"};return v(t.parent,u,!0)?(t.x=u.x,t.width=u.width,t.endDate=i.end,t.children.length<3&&(t.height=Math.min.apply(Math,[t.parent.height*n.Layout.timelineHeightRate,t.width*n.Settings.timelineMinAspect,t.height])),t.onMapExhibits=[],Object.keys(i.mapViewExhibits).forEach(function(n){t.onMapExhibits.push({id:n,mapAreaId:i.mapViewExhibits[n].mapAreaId})}),t.title=i.title,tt(t),n.Service.putTimeline(t).then(function(u){t.id="t"+u;t.guid=u;t.titleObject.id="t"+u+"__header__";Object.keys(i.mapViewExhibits).forEach(function(r){var u=n.VCContent.getChild(t,"e"+r);u&&(u.mapAreaId=i.mapViewExhibits[r].mapAreaId)});n.VCContent.removeChild(t,t.id+"__mapView");t.mapViewEnabled=null;t.parent.guid?n.Common.vc.virtualCanvas("requestInvalidate"):document.location.reload(!0);r.resolve(t)},function(n){r.reject(n)})):r.reject("Timeline intersects with parent timeline or other siblings"),r.promise()}function ut(t){var r=$.Deferred(),i;n.Service.deleteTimeline(t).then(function(){n.Common.vc.virtualCanvas("requestInvalidate");r.resolve()});i=!t.parent.guid;n.VCContent.removeChild(t.parent,t.id);i&&document.location.reload(!0)}function ft(t,i){var u=$.Deferred(),r;return t&&t.contentItems&&i?(r=$.extend({},t,{children:null}),r=$.extend(!0,{},r),delete r.children,delete r.contentItems,$.extend(!0,r,i),n.Service.putExhibit(r).then(function(t){r.guid=t.ExhibitId;for(var i=0;i<r.contentItems.length;i++)r.contentItems[i].ParentExhibitId=r.guid;$(t.ContentItemId).each(function(n,t){r.contentItems[n].id=t;r.contentItems[n].guid=t});r=s(r);r.id="e"+t.ExhibitId;n.Common.vc.virtualCanvas("requestInvalidate");u.resolve(r)},function(n){console.log("Error connecting to service: update exhibit.\n"+n.responseText);u.reject(n)})):u.reject(),u.promise()}function et(t){var i=$.Deferred(),r;return t&&t.id&&t.parent?(r=$.extend({},t,{children:null}),r=$.extend(!0,{},r),n.Service.deleteExhibit(r).then(function(){n.VCContent.removeChild(t.parent,t.id);n.Common.vc.virtualCanvas("requestInvalidate");i.resolve()},function(n){console.log("Error connecting to service: remove exhibit.\n"+n.responseText);i.reject()})):i.reject(),i.promise()}function ot(t,i,r){var u=$.Deferred(),f;return t&&t.contentItems&&t.contentItems.length&&i&&r?(f=$.extend(!0,{},i,r),n.Service.putContentItem(f).then(function(r){$.extend(i,f);i.id=i.guid=r;t=s(t);n.Common.vc.virtualCanvas("requestInvalidate");u.resolve()},function(n){console.log("Error connecting to service: update content item.\n"+n.responseText);u.reject(n)})):u.reject(),u.promise()}function st(t,i){var r=$.Deferred(),u;return t&&t.contentItems&&t.contentItems.length&&i&&i.index?(u=$.extend(!0,{},i),n.Service.deleteContentItem(u).then(function(){t.contentItems.splice(i.index,1);t=s(t);n.Common.vc.virtualCanvas("requestInvalidate");r.resolve()},function(n){console.log("Error connecting to service: remove content item.\n"+n.responseText);r.reject()})):r.reject(),r.promise()}function ht(t,i,r){var u=t!==!1&&i!==!1;return u=u&&n.Authoring.isNotEmpty(r),u&&n.Authoring.isIntervalPositive(t,i)}function ct(t,i,r){var u=t!==!1;return u=u&&n.Authoring.isNotEmpty(i),u&&n.Authoring.validateContentItems(r,null)}function lt(n){return!isNaN(Number(n)&&parseFloat(n))&&b(n)&&n!==!1}function b(n){return n!==""&&n!==null}function at(n){return/(http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(n)}function vt(n,t){return parseFloat(n)+1/366<=parseFloat(t)}function yt(t,i){var u=!0,e,r,f,h,a,v,y,o;if(t.length==0)return!1;for(e=0;t[e]!=null;){if(r=t[e],u=u&&n.Authoring.isNotEmpty(r.title)&&n.Authoring.isNotEmpty(r.uri)&&n.Authoring.isNotEmpty(r.mediaType),r.mediaType.toLowerCase()!=="video"&&(f=n.Service.getMimeTypeByUrl(r.uri)),r.mediaType.toLowerCase()==="image")h=/\.(jpg|jpeg|png|gif)$/i,h.test(r.uri)||f!="image/jpg"&&f!="image/jpeg"&&f!="image/gif"&&f!="image/png"&&(i&&i.showError("Sorry, only JPG/PNG/GIF images are supported."),u=!1);else if(r.mediaType.toLowerCase()==="video"){var c=/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|[\S\?\&]+&v=|\/user\/\S+))([^\/&#]{10,12})/,l=/vimeo\.com\/([0-9]+)/i;c.test(r.uri)?(a=r.uri.match(c)[1],r.uri="http://www.youtube.com/embed/"+a):l.test(r.uri)?(v=r.uri.match(l)[1],r.uri="http://player.vimeo.com/video/"+v):/player.vimeo.com\/video\/([0-9]+)/i.test(r.uri)||(i&&i.showError("Sorry, only YouTube or Vimeo videos are supported."),u=!1)}else if(r.mediaType.toLowerCase()==="pdf")y=/\.(pdf)$|\.(pdf)\?/i,y.test(r.uri)||f!="application/pdf"&&(i&&i.showError("Sorry, only PDF extension is supported."),u=!1);else if(r.mediaType.toLowerCase()==="skydrive-document")o=/(onedrive|skydrive)\.live\.com\/embed/,o.test(r.uri)||(alert("This is not a OneDrive embed link."),u=!1);else if(r.mediaType.toLowerCase()==="skydrive-image"){var s=r.uri.split(" "),o=/(onedrive|skydrive)\.live\.com\/embed/;o.test(s[0])&&/[0-9]/.test(s[1])&&/[0-9]/.test(s[2])||(i&&i.showError("This is not a OneDrive embed link."),u=!1)}if(!u)return!1;e++}return u}function pt(n){var t,r=[],i;if(n.indexOf("ErroneousContentItemIndex")+1)for(t=n.indexOf("ErroneousContentItemIndex")+27;n[t]!="]";)if(n[t]==","||n[t]=="["){for(i="",t++;n[t]!=","&&n[t]!="]";)i+=n[t],t++;r.push(parseInt(i))}return r}function k(){n.HomePageViewModel.sessionForm.show()}function wt(){n.Authoring.timer!=null&&(clearTimeout(n.Authoring.timer),n.Authoring.timer=setTimeout(function(){k()},(n.Settings.sessionTime-60)*1e3))}var e,o={},h={},f={},i={},l={type:"rectangle"},u={type:"rectangle"},a={type:"circle"},r={type:"circle"};t.selectedTimeline={};t.selectedExhibit={};t.selectedContentItem={};t.isActive=!1;t.isEnabled=!1;t.isDragging=!1;t.mode=null;t.contentItemMode=null;t.showCreateTimelineForm=null;t.showCreateRootTimelineForm=null;t.showEditTimelineForm=null;t.showCreateExhibitForm=null;t.showEditExhibitForm=null;t.showEditContentItemForm=null;t.showEditTourForm=null;t.showEditMapViewForm=null;t.showMessageWindow=null;t.hideMessageWindow=null;t.showSelectMapTypeForm=null;t.callback=null;t.timer;t.checkExhibitIntersections=y;t.renewExhibit=s;t.createNewTimeline=w;t.modeMouseHandlers={createTimeline:{mousemove:function(){n.Authoring.isDragging&&i.type==="timeline"&&g()},mouseup:function(){(f.x!==o.x||f.y!==o.y)&&i.type==="timeline"&&(n.VCContent.removeChild(i,"newTimelineRectangle"),t.selectedTimeline=w(),t.showCreateTimelineForm(t.selectedTimeline))}},editTour:{},"editTour-selectTarget":{mouseup:function(){t.callback!=null&&i!=undefined&&i!=null&&typeof i.type!="undefined"&&t.callback(i)},mousemove:function(){}},editTimeline:{mouseup:function(){t.showEditTimelineForm(t.selectedTimeline)}},createExhibit:{mousemove:function(){n.Authoring.isDragging&&i.type==="timeline"&&p()},mouseup:function(){i.type==="timeline"&&(p(),t.selectedExhibit=nt(),t.showCreateExhibitForm(t.selectedExhibit))}},editExhibit:{mouseup:function(){t.showEditExhibitForm(t.selectedExhibit)}},editContentItem:{mouseup:function(){t.showEditContentItemForm(t.selectedContentItem,t.selectedExhibit)}}};t.initialize=it;t.updateTimeline=rt;t.removeTimeline=ut;t.updateExhibit=ft;t.removeExhibit=et;t.updateContentItem=ot;t.removeContentItem=st;t.validateTimelineData=ht;t.validateExhibitData=ct;t.validateNumber=lt;t.isNotEmpty=b;t.isValidURL=at;t.isIntervalPositive=vt;t.validateContentItems=yt;t.erroneousContentItemsList=pt;t.showSessionForm=k;t.resetSessionTimer=wt})(n.Authoring||(n.Authoring={}));var t=n.Authoring})(CZ||(CZ={}));
/*
//# sourceMappingURL=authoring.min.js.map
*/