var CZ;(function(n){(function(t){function e(t){t.left=n.Dates.getCoordinateFromDecimalYear(t.start);t.right=n.Dates.getCoordinateFromDecimalYear(t.end);t.endDate=t.end;t.exhibits instanceof Array&&t.exhibits.forEach(function(t){t.x=n.Dates.getCoordinateFromDecimalYear(t.time);t.contentItems.forEach(function(t){n.Extensions.activateExtension(t.mediaType)})});t.timelines instanceof Array&&t.timelines.forEach(function(n){n.ParentTimeline=t;e(n)});k(t);t.Height?t.Height/=100:t.AspectRatio||t.Height||(t.Height=n.Layout.timelineHeightRate)}function k(t){t.ID==n.Settings.cosmosTimelineID&&(t.AspectRatio=10)}function o(t,r,u){var y=n.Settings.timelineHeaderSize+2*n.Settings.timelineHeaderMargin,c=t.right-t.left,e,l;t.width=c;t.AspectRatio&&!t.height&&(t.height=c/t.AspectRatio);t.timelines instanceof Array&&t.timelines.forEach(function(i){i.AspectRatio?i.height=(i.right-i.left)/i.AspectRatio:t.height&&i.Height&&(i.height=Math.min(t.height*i.Height,(i.right-i.left)*n.Settings.timelineMinAspect));o(i,c,u)});t.height||(e=undefined,t.timelines instanceof Array&&t.timelines.forEach(function(n){if(n.Height&&!n.AspectRatio){var t=n.height/n.Height;(!e||e<t)&&(e=t)}}),e&&(t.timelines instanceof Array&&t.timelines.forEach(function(n){if(n.Height&&!n.AspectRatio){var t=e*n.Height/n.height;t>1&&(n.realY*=t,h(n,t,u))}}),t.height=e));var a=g(t),p=d(t),f=s(t,a);if(t.height){if(l=i(t.height,t,u),t.exhibits instanceof Array&&t.exhibits.length>0&&p.max-p.min<t.height)while(f.max-f.min>t.height-l.bboxHeight&&a>c/20)a/=1.5,f=s(t,a);if(f.max-f.min>t.height-l.bboxHeight){var w=f.max-f.min,v=w/(1-y),l=i(v,t,u);t.height=v}t.titleRect=l}else{var b=f.min,k=f.max,nt=1/n.Settings.timelineMinAspect,tt=c/nt,w=Math.max((1-y)*tt,k-b),v=w/(1-y),l=i(v,t,u);t.titleRect=l;t.height=v}t.heightEps=r*n.Settings.timelineContentMargin;t.realHeight=t.height+2*t.heightEps;t.realY=0;t.exhibits instanceof Array&&t.exhibits.forEach(function(n){n.realY-=f.min});t.timelines instanceof Array&&t.timelines.forEach(function(n){n.realY-=f.min})}function u(n,t,i){n.forEach(function(n){var s=[],e,u,f,o,h,r;if(t.forEach(function(t){i(n,t)&&s.push({top:t.realY+t.realHeight,bottom:t.realY})}),e=0,s.length>0){for(u=[],s.forEach(function(n){u.push({type:"bottom",value:n.bottom});u.push({type:"top",value:n.top})}),u.sort(function(n,t){return n.value-t.value}),f=[],o=0,r=0;r<u.length-1;r++)u[r].type=="top"?o++:o--,o==0&&u[r+1].type=="bottom"&&f.push({bottom:u[r].value,top:u[r+1].value});for(h=!1,r=0;r<f.length;r++)if(f[r].top-f[r].bottom>n.realHeight){e=f[r].bottom;h=!0;break}h||(e=u[u.length-1].value)}n.realY=e;t.push(n)})}function s(n,t){var e=[],o=[],i,r,f;return n.timelines instanceof Array&&n.timelines.forEach(function(n){n.Sequence?e.push(n):o.push(n)}),n.exhibits instanceof Array&&n.exhibits.forEach(function(i){i.size=t;i.left=i.x-i.size/2;i.right=i.x+i.size/2;i.realHeight=t;i.left<n.left?(i.left=n.left,i.right=i.left+i.size,i.isDeposed=!0):i.right>n.right&&(i.right=n.right,i.left=n.right-i.size,i.isDeposed=!0);i.Sequence?e.push(i):o.push(i)}),e.sort(function(n,t){return n.Sequence-t.Sequence}),i=[],u(e,i,function(n,t){return n.left<t.right}),u(o,i,function(n,t){return!(n.left>=t.right||t.left>=n.right)}),r=Number.MAX_VALUE,f=Number.MIN_VALUE,i.forEach(function(n){n.realY<r&&(r=n.realY);n.realY+n.realHeight>f&&(f=n.realY+n.realHeight)}),i.length==0&&(f=0,r=0),{max:f,min:r}}function d(n){var r=[],t,i;return n.timelines instanceof Array&&u(n.timelines,r,function(n,t){return!(n.left>=t.right||t.left>=n.right)}),t=Number.MAX_VALUE,i=Number.MIN_VALUE,r.forEach(function(n){n.realY<t&&(t=n.realY);n.realY+n.realHeight>i&&(i=n.realY+n.realHeight)}),r.length==0&&(i=0,t=0),{max:i,min:t}}function h(n,t,r){if(t<1)throw"Only extending of content is allowed";n.height*=t;n.realHeight=n.height+2*n.heightEps;n.titleRect=i(n.height,n,r);n.timelines instanceof Array&&n.timelines.forEach(function(n){n.realY*=t;n.AspectRatio||h(n,t,r)});n.exhibits instanceof Array&&n.exhibits.forEach(function(n){n.realY*=t})}function c(n){n.y=n.realY+n.heightEps;n.exhibits instanceof Array&&n.exhibits.forEach(function(t){t.y=t.realY+t.size/2+n.y});n.timelines instanceof Array&&n.timelines.forEach(function(t){t.realY+=n.y;c(t)})}function g(n){return(n.right-n.left)/20}function i(t,i,r){var o=i.right-i.left;r.font="100pt "+n.Settings.timelineHeaderFontName;var s=r.measureText(i.title),u=n.Settings.timelineHeaderSize*t,e=u*s.width/100,f=Math.min(t,o)*n.Settings.timelineHeaderMargin;return e+2*f>o&&(e=o-2*f,u=e*100/s.width),{width:e-2.1*u,height:u,marginTop:t-u-f,marginLeft:f,bboxWidth:e+2*f-2.1*u,bboxHeight:u+2*f}}function l(t,i){var u=nt(i),r=n.VCContent.addTimeline(t,"layerTimelines","t"+i.id,{isBuffered:i.timelines instanceof Array,guid:i.id,timeStart:i.left,timeEnd:i.right,top:i.y,height:i.height,header:i.title,fillStyle:"rgba(0,0,0,0.25)",titleRect:i.titleRect,strokeStyle:u,regime:i.Regime,endDate:i.endDate,mapType:i.mapType,opacity:0});i.exhibits instanceof Array&&i.exhibits.forEach(function(t){var i=[],u,f;if(typeof t.contentItems!="undefined")for(i=t.contentItems,u=0;u<i.length;++u)i[u].guid=i[u].id;f=n.VCContent.addInfodot(r,"layerInfodots","e"+t.id,(t.left+t.right)/2,t.y,.8*t.size/2,i,{isBuffered:!1,guid:t.id,title:t.title,date:t.time,mapAreaId:t.mapAreaId,opacity:1})});i.timelines instanceof Array&&i.timelines.forEach(function(n){l(r,n)})}function nt(n){return n.Regime=="Cosmos"?"rgba(152, 108, 157, 1.0)":n.Regime=="Earth"?"rgba(81, 127, 149, 1.0)":n.Regime=="Life"?"rgba(73, 150, 73, 1.0)":n.Regime=="Pre-history"?"rgba(237, 145, 50, 1.0)":n.Regime=="Humanity"?"rgba(212, 92, 70, 1.0)":null}function tt(n,t){n.beginEdit();l(n,t);n.endEdit(!0)}function a(n,t){if(t){e(t);var i=document.createElement("canvas").getContext("2d");o(t,0,i);c(t);tt(n,t)}}function v(t,i){try{t.AspectRatio||(t.height=i.height);var r=new n.VCContent.CanvasRootElement(i.vc,undefined,"__root__",-Infinity,-Infinity,Infinity,Infinity);return a(r,t),r.children[0]}catch(u){console.log("exception in [nikita's layout]: "+u)}}function f(n,t){t&&(typeof n.y!="undefined"&&(n.y+=t,n.newY+=t),typeof n.baseline!="undefined"&&(n.baseline+=t,n.newBaseline+=t),n.children.forEach(function(n){f(n,t)}))}function y(n,t){t&&(typeof n.newY!="undefined"&&(n.newY+=t),typeof n.newBaseline!="undefined"&&(n.newBaseline+=t),n.children.forEach(function(n){y(n,t)}))}function it(n){for(var i,o,t,s=n.height/10,u=[],r=0;r<n.children.length;r++)i=n.children[r],i.type&&(i.type==="timeline"||i.type==="infodot")&&(i.force=0,u.push(i));for(u.sort(function(n,t){return n.newY-t.newY}),r=0;r<u.length;r++)if(i=u[r],i.type&&i.type==="timeline"&&i.delta){var f=i.x,e=i.x+i.width,h=i.y+i.newHeight+s;for(o=r+1;o<u.length;o++)if(t=u[o],t.x>f&&t.x<e||t.x+t.width>f&&t.x+t.width<e||t.x+t.width>f&&t.x+t.width===0&&e===0)if(t.y<h)t.force+=i.delta,f=Math.min(f,t.x),e=Math.max(e,t.x+t.width),h=t.y+t.newHeight+i.delta+s;else break}}function r(t){var f=n.Settings.canvasElementAnimationTime,u=[],i;if(t.fadeIn==!1&&typeof t.animation=="undefined"&&(t.height=t.newHeight,t.y=t.newY,t.baseline&&(t.baseline=t.newBaseline)),t.newY==t.y||t.id.match("__header__")||u.push({property:"y",startValue:t.y,targetValue:t.newY}),t.newHeight==t.height||t.id.match("__header__")||u.push({property:"height",startValue:t.height,targetValue:t.newHeight}),t.opacity!=1&&t.fadeIn==!1&&(u.push({property:"opacity",startValue:t.opacity,targetValue:1}),f=n.Settings.canvasElementFadeInTime),(b==!1||u.length==0)&&(f=0),rt(t,f,u),t.fadeIn==!0)for(i=0;i<t.children.length;i++)t.children[i].fadeIn==!0&&r(t.children[i]);else for(i=0;i<t.children.length;i++)r(t.children[i])}function rt(i,u,f){var e=(new Date).getTime();i.animation={isAnimating:!0,duration:u,startTime:e,args:f};typeof t.animatingElements[i.id]=="undefined"&&(t.animatingElements[i.id]=i,t.animatingElements.length++);i.calculateNewFrame=function(){var o=(new Date).getTime(),e,u;for(e=i.animation.duration>0?Math.min(1,(o-i.animation.startTime)/i.animation.duration):1,e=n.ViewportAnimation.animationEase(e),u=0;u<f.length;u++)typeof i[f[u].property]!="undefined"&&(i[i.animation.args[u].property]=i.animation.args[u].startValue+e*(i.animation.args[u].targetValue-i.animation.args[u].startValue));if(e==1){for(i.animation.isAnimating=!1,i.animation.args=[],delete t.animatingElements[i.id],t.animatingElements.length--,i.fadeIn==!1&&(i.fadeIn=!0),u=0;u<i.children.length;u++)typeof i.children[u].animation=="undefined"&&r(i.children[u]);return}}}function p(n){var t=n.toString().split(".");return t[0].replace(/\B(?=(\d{3})+(?!\d))/g,",")+(t[1]?"."+t[1]:"")}function w(t,i){var h,o,l,a,d,u,k,e,b,s,tt,r;if(t.id===i.guid){for(h=t.timelines instanceof Array?t.timelines:[],o=[],r=0;r<i.children.length;r++)i.children[r].type&&i.children[r].type==="timeline"&&o.push(i.children[r]);if(h.length===o.length){for(i.isBuffered=i.isBuffered||t.timelines instanceof Array,l=Number.MAX_VALUE,a=Number.MIN_VALUE,r=0;r<i.children.length;r++)i.children[r].type&&(i.children[r].type==="timeline"||i.children[r].type==="infodot")&&(i.children[r].newY<l&&(l=i.children[r].newY),i.children[r].newY+i.children[r].newHeight>a&&(a=i.children[r].newY+i.children[r].newHeight));for(i.delta=0,r=0;r<h.length;r++)w(h[r],o[r]);for(d=!1,r=0;r<o.length;r++)o[r].delta&&(d=!0);if(d){for(r=0;r<o.length;r++)o[r].delta&&(o[r].newHeight+=o[r].delta);for(it(i),r=0;r<i.children.length;r++)i.children[r].force&&y(i.children[r],i.children[r].force);var g=Number.MAX_VALUE,c=Number.MIN_VALUE,nt="";for(r=0;r<i.children.length;r++)i.children[r].type&&(i.children[r].type==="timeline"||i.children[r].type==="infodot")&&(i.children[r].newY<g&&(g=i.children[r].newY),i.children[r].newY+i.children[r].newHeight>c&&(c=i.children[r].newY+i.children[r].newHeight,nt=i.children[r].title));for(i.delta=Math.max(0,c-g-(a-l)),i.titleObject.newY+=i.delta,i.titleObject.newBaseline+=i.delta,i.titleObject.opacity=0,i.titleObject.fadeIn=!1,delete i.titleObject.animation,c>i.titleObject.newY&&(b=nt+" EXCEEDS "+i.title+".\nbottom: "+p(c)+"\n   top: "+p(i.titleObject.newY)+"\n",console.log(b)),r=1;r<i.children.length;r++)for(u=i.children[r],k=1;k<i.children.length;k++)e=i.children[k],u.id!==e.id&&(e.x<=u.x&&e.x+e.width<=u.x||e.x>=u.x+u.width&&e.x+e.width>=u.x+u.width||e.newY<=u.newY&&e.newY+e.newHeight<=u.newY||e.newY>=u.newY+u.newHeight&&e.newY+e.newHeight>=u.newY+u.newHeight||(b=u.title+" OVERLAPS "+e.title+".\n",console.log(b)))}}else if(h.length>0&&o.length===0){for(s=v(t,i),tt=Math.min(s.width,s.newHeight)*n.Settings.timelineHeaderMargin,i.delta=Math.max(0,s.newHeight-i.newHeight),i.children.splice(0),r=0;r<s.children.length;r++)i.children.push(s.children[r]);for(i.titleObject=i.children[0],i.isBuffered=i.isBuffered||t.timelines instanceof Array,r=0;r<i.children.length;r++)f(i.children[r],i.newY)}else i.delta=0}else throw"error: Cannot merge timelines. Src and dest node ids differ.";}function ut(t,i){if((typeof n.Authoring=="undefined"||!n.Authoring.isActive)&&t&&i)if(i.id==="__root__"){t.AspectRatio=10;var u=v(t,i);f(u,0);i.children.push(u);r(i);n.Common.vc.virtualCanvas("requestInvalidate")}else w(t,i),i.newHeight+=i.delta,r(i),n.Common.vc.virtualCanvas("requestInvalidate")}var b=!0;t.animatingElements={length:0};t.timelineHeightRate=.4;t.GenerateTitleObject=i;t.FindChildTimeline=function(n,i,r){var u=undefined,o,f,e;if(n&&n.timelines instanceof Array)for(o=n.timelines.length,f=0;f<o;f++)if(e=n.timelines[f],e.id==i){u=e;break}else if(r==!0&&(u=t.FindChildTimeline(e,i,r),u!=undefined))break;return u};t.Load=a;t.Merge=ut})(n.Layout||(n.Layout={}));var t=n.Layout})(CZ||(CZ={}));
/*
//# sourceMappingURL=layout.min.js.map
*/